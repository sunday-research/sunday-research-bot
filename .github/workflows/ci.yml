name: CI/CD Pipeline

on:
    push:
        branches: [dev, issue-20]
    workflow_dispatch:

permissions:
    contents: read

jobs:
    # Этап 1: Линтинг и тесты
    lint:
        runs-on: ubuntu-latest
        
        services:
            postgres:
                image: postgres:16
                env:
                    POSTGRES_DB: test_sunday_research_bot
                    POSTGRES_USER: test_sunday_research_bot
                    POSTGRES_PASSWORD: '!ChangeMe!'
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5
                ports:
                    - 5432:5432

        env:
            APP_ENV: test
            POSTGRES_HOST: localhost
            PGPASSWORD: '!ChangeMe!'

        steps:
            - uses: actions/checkout@v4
            - name: Validate composer.json
              run: composer validate --strict
            - name: Cache Composer packages
              uses: actions/cache@v3
              with:
                  path: vendor
                  key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
            - name: Setup PHP 8.2
              uses: shivammathur/setup-php@v2
              with:
                  php-version: "8.2"
                  extensions: pdo_pgsql
            - name: Install dependencies
              run: composer install --prefer-dist --no-progress
            - name: Run PHP-CS-Fixer
              run: composer php-cs-fixer-diff
            - name: Run PHPStan
              run: composer phpstan-full-scan
            - name: Wait for PostgreSQL
              run: |
                  until pg_isready -h localhost -p 5432 -U test_sunday_research_bot; do
                      echo "Waiting for Postgres..."; sleep 1;
                  done
            - name: Run migrations
              run: php bin/console doctrine:migrations:migrate --no-interaction --env=test
            - name: Run tests
              run: composer phpunit

    # Этап 2: Деплой (только если линтер прошел)
    deploy:
        runs-on: ubuntu-latest
        needs: lint  # Ключевая строка!
        environment: production
        
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Deploy via SSH
              uses: appleboy/ssh-action@v1.0.0
              with:
                  host: ${{ secrets.REMOTE_HOST }}
                  username: ${{ secrets.REMOTE_USER }}
                  key: ${{ secrets.DEPLOY_KEY }}
                  port: 22
                  timeout: 60s
                  command_timeout: 10m
                  script: |
                      cd /var/www/sunday-research-bot
                      
                      BRANCH=${{ github.ref_name }}
                      echo "Deploying branch: $BRANCH"
                      
                      # Настройка Git для работы с репозиторием
                      git config --global --add safe.directory /var/www/sunday-research-bot
                      
                      # Настройка SSH для работы с Deploy Key
                      mkdir -p ~/.ssh
                      chmod 700 ~/.ssh
                      echo "Host github.com" >> ~/.ssh/config
                      echo "  StrictHostKeyChecking no" >> ~/.ssh/config
                      echo "  UserKnownHostsFile /dev/null" >> ~/.ssh/config
                      
                      # Безопасный git pull
                      git checkout $BRANCH --force
                      git reset --hard HEAD
                      git clean -fd
                      git fetch origin
                      git reset --hard origin/$BRANCH
                      
                      echo "Deployed: $(git rev-parse HEAD)"
                      
                      # Проверяем существование файла compose
                      if [ ! -f "compose-prod.yaml" ]; then
                          echo "compose-prod.yaml not found, using compose.yaml"
                          COMPOSE_FILE="compose.yaml"
                      else
                          COMPOSE_FILE="compose-prod.yaml"
                      fi
                      
                      # Останавливаем и перезапускаем контейнеры
                      docker compose -f $COMPOSE_FILE down
                      docker compose -f $COMPOSE_FILE up -d --build
                      
                      # Ждем запуска контейнеров
                      echo "Waiting for containers to be ready..."
                      until docker compose -f $COMPOSE_FILE ps | grep -q "Up"; do
                          echo "Waiting for containers..."; sleep 2;
                      done
                      
                      # Дополнительная проверка готовности Symfony контейнера
                      echo "Waiting for Symfony container to be ready..."
                      until docker compose -f $COMPOSE_FILE exec symfony pgrep php-fpm > /dev/null 2>&1; do
                          echo "Waiting for PHP-FPM..."; sleep 2;
                      done
                      
                      # Устанавливаем зависимости и очищаем кэш
                      docker compose -f $COMPOSE_FILE exec symfony composer install --no-dev --optimize-autoloader
                      docker compose -f $COMPOSE_FILE exec symfony php bin/console cache:clear --env=prod
