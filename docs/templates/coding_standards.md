# Стандарты кодирования Sunday Research Bot

## Общие принципы

### 1. Архитектурные принципы
- **SOLID принципы**: Строгое соблюдение всех пяти принципов
- **Domain-Driven Design (DDD)**: Использование доменно-ориентированного подхода
- **Clean Architecture**: Разделение на слои с четкими границами
- **Low Coupling, High Cohesion**: Минимальная связанность, высокая сплоченность
- **Dependency Inversion**: Зависимость от абстракций, а не от конкретных реализаций

### 2. Модульная архитектура
Проект построен на модульной архитектуре, где каждый модуль:
- Имеет четкие границы и ответственности
- Может быть независимо тестирован
- Следует принципу единственной ответственности
- Имеет собственную структуру слоев

## Технические требования

### 1. PHP и Symfony
- **PHP**: 8.2.9+ с использованием современных возможностей языка
- **Symfony**: 7.0+ с соблюдением лучших практик фреймворка
- **Doctrine ORM**: 3.2+ с использованием современных подходов

### 2. Статический анализ
- **PHPStan**: Уровень 10 (максимальный) для всех файлов
- **PHP-CS-Fixer**: PSR-12 стандарт для директории `./src`
- **Строгая типизация**: Обязательное использование типов везде, где это возможно

## Структура модуля

### 1. Стандартная структура модуля
```
Module/
├── Contract/          # Интерфейсы и контракты
├── DTO/               # Data Transfer Objects
├── Entity/            # Доменные сущности
├── Enum/              # Перечисления
├── Exception/         # Исключения модуля
├── Factory/           # Фабрики
├── Handler/           # Обработчики
├── Infrastructure/    # Инфраструктурный слой
│   ├── Doctrine/      # Работа с БД
│   ├── Redis/         # Работа с Redis
│   └── Telegram/      # Внешние API
├── Message/           # Сообщения для Messenger
├── MessageHandler/    # Обработчики сообщений
├── Service/           # Сервисы бизнес-логики
└── ValueObject/       # Объекты-значения
```

### 2. Иерархия вызовов
```
CLI/Controller → Manager → Service → Repository
```

## Принципы именования

### 1. Классы
- **Manager**: Высокоуровневые классы бизнес-логики
- **Service**: Классы-кирпичики для конкретных операций
- **Repository**: Классы для работы с хранилищами
- **Factory**: Классы для создания объектов
- **Handler**: Классы для обработки событий/команд
- **DTO**: Объекты для передачи данных
- **ValueObject**: Неизменяемые объекты-значения

### 2. Методы
- Использовать глаголы в инфинитиве: `create()`, `update()`, `delete()`
- Для получения данных: `get*()`, `find*()`, `retrieve*()`
- Для проверок: `is*()`, `has*()`, `can*()`

## Типизация и аннотации

### 1. Обязательные требования
- Все методы должны иметь типы параметров и возвращаемых значений
- Использовать `readonly` классы где это уместно
- Добавлять `@phpstan-ignore-next-line` только при необходимости

### 2. Примеры типизации
```php
/**
 * @param array<string, mixed> $data
 * @return array<int, string>
 */
public function processData(array $data): array
{
    // implementation
}
```

## Обработка ошибок

### 1. Исключения
- Создавать специфичные исключения для каждого модуля
- Использовать иерархию исключений
- Добавлять контекстную информацию в исключения

### 2. Логирование
- Использовать PSR-3 Logger
- Логировать на соответствующих уровнях (debug, info, warning, error)
- Включать контекстную информацию

## Тестирование

### 1. Структура тестов
- Тесты должны соответствовать структуре модулей
- Использовать PHPUnit 10.5+
- Следовать принципу AAA (Arrange, Act, Assert)

### 2. Покрытие
- Стремиться к 100% покрытию кода
- Тестировать как позитивные, так и негативные сценарии
- Использовать моки для внешних зависимостей

## Работа с данными

### 1. DTO
- Использовать для передачи данных между слоями
- Делать неизменяемыми (readonly)
- Валидировать данные на входе

### 2. Value Objects
- Использовать для представления концепций домена
- Делать неизменяемыми
- Реализовывать `equals()` метод

### 3. Entities
- Представлять доменные сущности
- Содержать бизнес-логику
- Использовать Doctrine ORM для персистентности

## Конфигурация и зависимости

### 1. Dependency Injection
- Использовать конструктор-инъекцию
- Избегать сервис-локаторов
- Использовать интерфейсы для абстракций

### 2. Конфигурация
- Использовать YAML для конфигурации Symfony
- Выносить чувствительные данные в переменные окружения
- Использовать .env файлы для локальной разработки

## Производительность

### 1. Оптимизации
- Использовать lazy loading где это уместно
- Кэшировать результаты дорогих операций
- Оптимизировать запросы к БД

### 2. Мониторинг
- Логировать время выполнения операций
- Использовать профилирование в разработке
- Мониторить использование памяти

## Безопасность

### 1. Валидация
- Валидировать все входные данные
- Использовать фильтрацию для предотвращения XSS
- Проверять права доступа

### 2. Конфиденциальность
- Не логировать чувствительные данные
- Использовать HTTPS для внешних API
- Хранить секреты в переменных окружения

## Документация

### 1. Код
- Использовать PHPDoc для публичных методов
- Добавлять комментарии для сложной бизнес-логики
- Документировать исключения и их причины

### 2. Архитектура
- Поддерживать актуальную документацию архитектуры
- Документировать решения (ADR - Architecture Decision Records)
- Описывать API и контракты

## CI/CD

### 1. Проверки качества
- Запускать PHP-CS-Fixer перед коммитом
- Проверять код PHPStan на максимальном уровне
- Запускать тесты в CI/CD пайплайне

### 2. Автоматизация
- Использовать composer scripts для стандартных операций
- Автоматизировать развертывание
- Мониторить качество кода

## Рекомендации по разработке

### 1. Рабочий процесс
- Следовать принципу "сделай простое простым"
- Рефакторить код регулярно
- Использовать code review для всех изменений

### 2. Современные практики
- Использовать современные возможности PHP 8.2+
- Следовать PSR стандартам
- Применять функциональное программирование где это уместно 